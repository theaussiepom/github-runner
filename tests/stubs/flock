#!/usr/bin/env bash
set -euo pipefail

calls_file="${APPLIANCE_CALLS_FILE:-/dev/null}"
printf 'flock %q\n' "$*" >>"$calls_file" || true

if [[ -n "${APPLIANCE_STUB_FLOCK_TOUCH_MARKER:-}" ]]; then
	marker_path="${APPLIANCE_INSTALLED_MARKER:-}"
	if [[ -n "$marker_path" ]]; then
		mkdir -p "${marker_path%/*}" || true
		: >"$marker_path" || true
	fi
fi

exit "${APPLIANCE_STUB_FLOCK_EXIT_CODE:-0}"
